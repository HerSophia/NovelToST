# NovelToST 测试规范（v1）

> 目标：为 `src/novelToST` 建立可落地的**单元测试（Unit Test）**与**集成测试（Integration Test）**标准，确保后续新增测试时口径一致、可维护、可接入 CI。

## 1. 适用范围

本规范适用于以下目录：

- `src/novelToST/core/*`
- `src/novelToST/stores/*`
- `src/novelToST/composables/*`
- `src/novelToST/commands/*`
- `src/novelToST/ui/*`（以组件行为测试为主）

不在本规范首批范围内：

- 真实 SillyTavern 环境端到端（E2E）自动化
- 浏览器下载行为的真实文件落盘校验（仅校验调用与参数）

---

## 2. 测试分层定义

### 2.1 单元测试（Unit）

**定义**：对“单个函数/单个 store/单个组件”进行隔离验证，依赖均可 mock/stub。  
**目标**：验证纯逻辑、边界值、异常路径。

典型对象：

- `extract.service.ts` 的纯函数（`parseTagInput`、`extractTagContents`）
- `guard.service.ts` 的错误规范化、状态守卫
- 各 Pinia store 的状态流转

### 2.2 集成测试（Integration）

**定义**：验证“模块之间协作行为”，允许真实组合多个 store/composable/service，但仍屏蔽外部平台依赖。  
**目标**：验证关键业务链路与状态闭环。

典型对象：

- `useGenerationControl` + stores + core services
- `generation.service` 章节循环、重试、停止、自动保存触发
- `commands/debug.ts` 的命令入口与返回结构

---

## 3. 技术栈与运行环境（建议基线）

- Test Runner：`vitest`
- 覆盖率：`@vitest/coverage-v8`
- Vue 组件测试：`@vue/test-utils`
- DOM 环境：`happy-dom`
- Pinia 测试：`@pinia/testing`（可选，store 真实实例优先）

> 说明：本项目依赖大量全局 API（如 `getChatMessages`、`toastr`、`retrieveDisplayedMessage`），测试环境必须统一注入 mock（见第 5 节）。

---

## 4. 目录与命名规范

建议新增目录：

```txt
tests/
  setup/
    vitest.setup.ts
    st-globals.mock.ts
  unit/
    core/
    stores/
    commands/
  integration/
    composables/
    core/
```

命名规则：

- `*.spec.ts`：单元测试
- `*.int.spec.ts`：集成测试

用例命名建议：

- `should ... when ...`
- 中文可读版也可接受，如：`应在章节长度不足时抛出错误`

---

## 5. Mock 规范（SillyTavern 全局能力）

### 5.1 必须集中管理

所有全局 mock 必须在 `tests/setup/st-globals.mock.ts` 统一维护，禁止在各测试文件临时散落定义，避免行为漂移。

### 5.2 首批需 mock 的全局对象/函数

- 聊天相关：
  - `getLastMessageId`
  - `getChatMessages`
  - `createChatMessages`
  - `retrieveDisplayedMessage`
  - `triggerSlash`
- 脚本变量：
  - `getScriptId`
  - `getVariables`
- UI/通知：
  - `toastr.success / warning / error / info`
- 按钮/事件：
  - `replaceScriptButtons`
  - `eventOn`
  - `getButtonEvent`

### 5.3 Mock 原则

1. 默认返回“最小可用值”（避免过度复杂 mock）。
2. 每个测试只覆写自己关心的行为。
3. 每个 `it` 结束后清理：`vi.restoreAllMocks()`、重置 Pinia。
4. 涉及轮询/超时逻辑统一用 fake timers（`vi.useFakeTimers()`）。

---

## 6. 单元测试规范

### 6.1 结构

采用 AAA 模式：

1. Arrange（准备输入与 mock）
2. Act（执行目标函数）
3. Assert（断言结果与副作用）

### 6.2 覆盖要求

每个核心函数至少覆盖：

- 正常路径（happy path）
- 边界值（空字符串、0、负值、最小/最大阈值）
- 异常路径（抛错、超时、返回空）

### 6.3 不推荐行为

- 断言实现细节（如内部私有变量名）
- 使用真实等待（`await sleep(5000)`）
- 在测试中依赖当前系统时间戳做强比较（应 mock `Date.now`）

---

## 7. 集成测试规范

### 7.1 测试边界

集成测试允许真实串联：

- composable ↔ stores ↔ services

但仍需隔离：

- 真实网络/真实 ST 客户端
- 真实下载、真实浏览器弹窗

### 7.2 必测业务链路（P0）

1. `useGenerationControl.start`
   - 正常完成：状态 `running -> completed`，触发成功提示
   - 用户停止：状态回到 idle，提示“任务已停止”
   - 异常失败：`markError + openErrorModal + toastr.error`

2. `startLoop`
   - 重试成功路径（前 N 次失败，后续成功）
   - 重试耗尽路径（记录错误并推进章节）
   - `autoSaveInterval` 命中时触发 `onAutoSave`

3. `collectChapters` + `buildTagPreview`
   - 标签模式与全量模式切换
   - `useRawContent` 对 raw/display 取值差异

4. `registerNovelDebugCommand`
   - 命令注册/卸载
   - `floor/latest/tagPreview/extract` 返回结构稳定

---

## 8. 首批测试清单（建议）

### 8.1 Unit 清单

- `core/extract.service.spec.ts`
  - `parseTagInput` 多分隔符解析
  - `extractTagContents` 多标签、多次匹配、无匹配
- `core/guard.service.spec.ts`
  - `normalizeError` 各输入类型
  - `ensureChatReady` 空聊天抛错
  - `waitForResumeOrAbort` 暂停与中止
- `core/export.service.spec.ts`
  - `buildTxtContent`/`buildJsonContent` 输出结构
- `stores/*.spec.ts`
  - `generation.store` 状态机流转
  - `settings.store` patch/默认值/容错
  - `export.store` 与 `ui.store` 基础行为

### 8.2 Integration 清单

- `composables/useGenerationControl.int.spec.ts`
- `core/generation.service.int.spec.ts`
- `commands/debug.int.spec.ts`

---

## 9. 覆盖率与质量门禁

初始门槛（v1，先达标再抬高）：

- 行覆盖率（Lines）：`>= 70%`
- 分支覆盖率（Branches）：`>= 60%`
- 核心目录 `src/novelToST/core/*` 行覆盖率：`>= 80%`

PR 合并前至少满足：

- [ ] `lint` 通过
- [ ] `typecheck` 通过
- [ ] `test --run` 通过
- [ ] `build:dev` 通过
- [ ] 涉及行为改动的测试已补齐（单测或集成至少其一）

---

## 10. CI 接入规范（当前已落地）

当前 `test.yaml` 已执行：`lint + typecheck + test --run + build:dev`。

1. `pnpm lint`
2. `pnpm typecheck`
3. `pnpm test --run`
4. `pnpm build:dev`

可选增强：在失败时上传覆盖率报告或增加长稳 soak 任务。

---

## 11. 提交流程规范

当 PR 含测试改动时，描述中应包含：

1. 新增/修改了哪些测试文件
2. 覆盖了哪些场景（尤其异常分支）
3. 未覆盖项与原因（如果有）

建议 commit 前缀：

- `test:` 新增/修改测试
- `docs:` 测试规范文档更新

---

## 12. 版本记录

- `v1`（2026-02-24）：建立 NovelToST 单元测试与集成测试统一规范。
- `v1+`（2026-03-01）：同步 CI 已落地门禁（lint/typecheck/test/build）与 PR 质量检查项。
