# 仓库历史清理（建议方案）

> 目的：当历史提交中包含大量无效产物、误提交内容或需要重新整理历史时，提供一套可执行且可回滚的流程。

## 1. 何时需要历史清理

- 仓库体积异常增长，且主要由历史冗余造成。
- 历史中包含不应保留的文件（敏感信息、误提交大文件）。
- 项目已进入新阶段，希望从干净历史重新开始。

## 2. 风险提示

历史重写会改变 commit hash，影响所有协作者本地分支。必须：

- 提前公告并冻结合并窗口。
- 在重写前创建备份 tag/镜像仓库。
- 明确“失败时回滚”路径。

## 3. 两种常见方式

### 3.1 方式 A：从当前状态重建单提交历史（最简单）

适合：不需要保留旧提交细节，只保留当前文件状态。

示例流程：

```bash
# 1) 新建孤儿分支

git checkout --orphan clean-main

# 2) 提交当前全部文件

git add -A
git commit -m "chore: reinitialize repository history"

# 3) 备份旧 main

git branch backup/main-old

# 4) 用新历史替换 main

git branch -M clean-main main
git push --force-with-lease origin main
```

### 3.2 方式 B：定向移除历史中的特定路径/文件

适合：需要保留大部分历史，仅移除某些内容。

建议使用 `git filter-repo`（需本地安装）按路径或规则清理，再强推。

## 4. 团队执行清单

- [ ] 在 Issue/PR 公告执行时间
- [ ] 创建备份 tag（如 `before-history-cleanup-YYYYMMDD`）
- [ ] 冻结合并窗口
- [ ] 执行重写并推送
- [ ] 通知成员执行本地重置

## 5. 协作者本地同步命令（清理后）

```bash
git fetch origin
git checkout main
git reset --hard origin/main
git clean -fd
```

## 6. 建议

- 若当前痛点主要是流程复杂，而非历史污染，优先先做 CI/协作规范收敛。
- 历史清理建议作为单独里程碑执行，不与功能开发混在同一次 PR。
