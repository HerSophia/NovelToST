# NovelToST 对齐报告（最终版，阶段0基线 + T1~T9 执行记录 + P0 别名合并收口）

> 更新时间：2026-02-27（本轮含 P0 别名合并收口）
> 对齐对象：
>
> - `参考项目/Novel-Auto-Generator/index.js`（1379 行）
> - `参考项目/Novel-Auto-Generator/txtToWorldbook.js`（10607 行）

---

## 1. 评估口径

采用执行计划中的加权模型（总分 100）：

- A. 主续写能力：35
- B. Worldbook 能力：45
- C. 工程质量：20

状态定义：

- **Aligned**：核心行为已闭环，且有代码与测试证据。
- **Partial**：有实现但缺关键交互/流程/验证。
- **Not aligned**：当前无实现或仅有占位。

---

## 2. 证据快照（当前仓库）

### 2.1 最终门禁运行证据（本轮复验）

- `pnpm lint -- --max-warnings=20`
  - 结果：✅ 通过
  - 输出：`0 errors, 1 warning`
  - 保留 warning：`vitest.config.ts` line `1` `import-x/no-nodejs-modules`
- `pnpm test --run`
  - 结果：✅ 通过
  - 汇总：`Test Files 31 passed` / `Tests 151 passed`
  - 时长：`Duration 23.88s`
- `pnpm build:dev`
  - 结果：✅ 通过
  - 输出：`webpack 5.105.2 compiled successfully`
- `pnpm test:coverage -- --reporter=default`
  - 结果：✅ 通过
  - 汇总：`Test Files 31 passed` / `Tests 151 passed`
  - Coverage (`All files`):
    - Lines: **74.21%**
    - Branches: **67.45%**
    - Funcs: **84.21%**
    - Stmts: **74.21%**

### 2.2 稳定性观测证据（T9）

本轮补充了两段回归观测窗口，重点验证 worldbook 核心改动（T5/T6）与全链路门禁在重复执行下的稳定性。

#### 观测窗口 A：关键 worldbook 路径重复执行

- 命令：循环执行 `pnpm test --run tests/unit/core/worldbook/st-format.service.spec.ts tests/unit/composables/useWorldbookControl.spec.ts --reporter=dot`（4 轮）+ `pnpm build:dev`（1 轮）
- 记录：
  - `OBS_WINDOW_START=2026-02-27 22:33:50`
  - `OBS_WINDOW_END=2026-02-27 22:34:38`
  - `OBS_WINDOW_MIN=0.79`

| Round | Step | DurationSec | ExitCode |
| --- | --- | ---: | ---: |
| 1 | worldbook-critical-tests | 5.88 | 0 |
| 2 | worldbook-critical-tests | 5.97 | 0 |
| 3 | worldbook-critical-tests | 7.23 | 0 |
| 4 | worldbook-critical-tests | 7.00 | 0 |
| final | build:dev | 21.33 | 0 |

#### 观测窗口 B：全链路 soak 回归

- 命令：2 轮 `pnpm test --run` + `pnpm build:dev`，随后 1 轮 `pnpm test:coverage -- --reporter=default`
- 记录：
  - `SOAK_WINDOW_START=2026-02-27 22:35:07`
  - `SOAK_WINDOW_END=2026-02-27 22:37:01`
  - `SOAK_WINDOW_MIN=1.91`

| Round | Step | DurationSec | ExitCode |
| --- | --- | ---: | ---: |
| 1 | test --run | 27.47 | 0 |
| 1 | build:dev | 17.28 | 0 |
| 2 | test --run | 27.89 | 0 |
| 2 | build:dev | 14.82 | 0 |
| final | test:coverage | 26.83 | 0 |

**T9 稳定性结论（可追溯）**：

- 两段窗口累计约 `2.70` 分钟，所有步骤 `ExitCode=0`；
- 观测期间未出现进程挂起、超时中断、失败重跑；
- 测试输出中的 `ZodError` 日志与 `debug unknown-command` 日志属于用例预期断言路径，不构成回归失败。

### 2.3 代码规模快照（历史评估基线）

- Worldbook 相关代码：`src/novelToST/core/worldbook/*.ts` + `ui/components/worldbook/*.vue` + `stores/worldbook.store.ts` + `composables/useWorldbookControl.ts`
  - **21 文件 / 7073 行**
- 非 worldbook 主要范围
  - **30 文件 / 3385 行**

### 2.4 CI 快照

- `build` 工作流：`.github/workflows/build.yaml`
  - Node `24`，pnpm `10`，`pnpm install --frozen-lockfile` + `pnpm build`
- `test` 工作流：`.github/workflows/test.yaml`
  - 已包含：
    - `pnpm install --frozen-lockfile`
    - `pnpm lint`
    - `pnpm test --run`
    - `pnpm build:dev`

---

## 3. A 维度：`index.js`（主续写）对齐矩阵

| 参考能力 | NovelToST 证据 | 状态 | 备注 |
| --- | --- | --- | --- |
| 自动续写主循环、重试、暂停/恢复/停止 | `src/novelToST/core/generation.service.ts`（`startLoop`, `generateSingleChapter`） | Aligned | 主链路完整 |
| 双阶段弹窗检测（发送/回复） | `src/novelToST/core/guard.service.ts`（`waitForSendStageSettled`, `waitForReplyStageSettled`）；`generation.service.ts` 调用；`tests/unit/core/guard.toast.spec.ts` | Aligned | 与参考两阶段语义一致 |
| 高级参数（发送/回复超时、额外等待） | `src/novelToST/stores/settings.store.ts` `ScriptSettingsSchema` 字段：`enableSendToastDetection/sendToastWaitTimeout/sendPostToastWaitTime`、`enableReplyToastDetection/replyToastWaitTimeout/replyPostToastWaitTime`；`ui/components/GenerationForm.vue` 对应输入项 | Aligned | 参数可配置、可持久化 |
| raw/display 内容切换与标签提取 | `settings.store.ts` `useRawContent`; `commands/debug.ts`（`floor`, `extract`）；`GenerationForm.vue` 开关 | Aligned | 调试可见性较好 |
| 调试入口 | `src/novelToST/commands/debug.ts` `registerNovelDebugCommand` + `window.novelToSTDebug`; `tests/integration/commands/debug.int.spec.ts` | Aligned | 覆盖 help/floor/latest/extract 等 |
| 帮助系统 | `src/novelToST/ui/components/HelpPanel.vue` + `src/novelToST/ui/App.vue` 挂载 | Partial | 有帮助面板，但与参考“分面板问号弹窗体系”仍有差距 |

### A 小结（建议打分）：31 / 35

---

## 4. B 维度：`txtToWorldbook.js`（Worldbook）对齐矩阵

| 参考能力 | NovelToST 证据 | 状态 | 备注 |
| --- | --- | --- | --- |
| TXT 输入与切块 | `ui/components/worldbook/WorldbookPanel.vue` 文件上传/粘贴；`core/worldbook/chunk.service.ts`（`buildMemoryChunksFromText`） | Aligned | 可用 |
| 串行/并行处理、重试、停止控制 | `core/worldbook/process.service.ts`（`processWorldbookChunks`）；`useWorldbookControl.ts`（`start/pause/resume/stop`） | Aligned | 有并发模式与重试 |
| 多 API 适配（酒馆 + 自定义） | `core/worldbook/api.service.ts`（`callSillyTavernAPI`, `callCustomAPI`, `callAPI`） | Aligned | 提供商覆盖较广 |
| 历史追踪与回滚 | `core/worldbook/history-db.service.ts`; `ui/components/worldbook/HistoryModal.vue`; `useWorldbookControl.ts` `doRollbackToHistory` | Aligned | 有历史列表与回退 |
| 重 Roll（块/条目） | `core/worldbook/reroll.service.ts`; `WorldbookPanel.vue` + `RerollModal.vue`; `useWorldbookControl.ts` `doRerollChunk/doRerollEntry` | Aligned | 单块/单条目可重 Roll |
| 任务/设置导入导出 | `core/worldbook/task-io.service.ts` + `useWorldbookControl.ts` `doImport/ExportTaskState`, `doImport/ExportSettings`; `tests/unit/core/worldbook/task-io.service.spec.ts` | Aligned | JSON 往返与错误处理可测 |
| 查找替换 | `ui/components/worldbook/SearchReplaceModal.vue` | Aligned | 批量替换已具备 |
| 模型列表拉取 + 快速 API 测试 | `core/worldbook/api.service.ts`：`fetchCustomApiModels`、`quickTestWorldbookApi`; `composables/useWorldbookControl.ts` 状态/动作；`WorldbookSettingsPanel.vue` + `WorldbookPanel.vue` 接入；`tests/unit/core/worldbook/api.service.spec.ts`、`tests/unit/composables/useWorldbookControl.spec.ts` | Aligned | T1 已落地 |
| 批量编辑（多选删除） | `WorldbookResultPanel.vue` 多选 + `@remove-entries`; `useWorldbookControl.ts` `removeEntries/removeEntry(确认)` + 撤销快照；`tests/unit/composables/useWorldbookControl.spec.ts` | Aligned | T2 已落地（含确认+撤销） |
| 记忆块上/下合并（用户显式操作） | `MemoryQueuePanel.vue` `merge-up/merge-down`; `core/worldbook/chunk.service.ts` `mergeAdjacentChunks`; `useWorldbookControl.ts` `mergeChunkUp/mergeChunkDown` + 受影响条目清理与撤销；`tests/unit/core/worldbook/chunk.service.spec.ts` | Aligned | T2 已落地 |
| 起始块索引（从第 N 块继续） | `types.ts` `worldbook.startChunkIndex`; `settings.store.ts` `WorldbookSettingsSchema/LEGACY_WORLDBOOK_KEYS`; `WorldbookSettingsPanel.vue` 起始块序号；`useWorldbookControl.ts` `resolveWorldbookStartChunkIndex/applyWorldbookStartChunkIndex` 并在 `start()` 接入；`tests/unit/stores/settings.store.spec.ts`、`tests/unit/core/worldbook/task-io.service.spec.ts`、`tests/unit/composables/useWorldbookControl.spec.ts` | Aligned | T3 已落地 |
| 失败块修复队列（失败列表+单/批重试） | `MemoryQueuePanel.vue` 失败队列（失败原因/失败次数/重试状态）+ “全部重试/单块重试”；`WorldbookPanel.vue` 事件接线；`useWorldbookControl.ts` `retryFailedChunk/retryAllFailedChunks/runChunkProcessing`；`tests/unit/composables/useWorldbookControl.spec.ts`、`tests/unit/stores/worldbook.store.spec.ts` | Aligned | T4 已落地 |
| SillyTavern 导入/导出完整格式 + 导入合并流 | `core/worldbook/st-format.service.ts`：ST 格式转换（`entries/uid/key/comment/position/depth/order/disable`）+ 导入解析（`entries` array/object、`merged` 兼容）+ 冲突合并执行；`useWorldbookControl.ts`：`doExportEntries/doPrepareImportEntries/doConfirmImportEntriesMerge`; `WorldbookResultPanel.vue` 导入入口；`WorldbookPanel.vue` + `ImportMergeModal.vue` 导入确认流；`tests/unit/core/worldbook/st-format.service.spec.ts` + `fixtures/import/*` 覆盖 standard/missing-field/conflict 与 `ai/replace/keep/rename/append` | Aligned | T5/T6 已落地 |
| 别名合并完整工作流 | `core/worldbook/st-format.service.ts`：`performWorldbookImportMerge` 新增 `aliasMerge` 选项并调用 `mergeWorldbookAliases`；`ImportMergeModal.vue`：别名规则输入（`分类::主条目=别名1,别名2`）+ 策略配置（`append/replace/keep`、保留别名）；`WorldbookPanel.vue` + `useWorldbookControl.ts`：确认负载透传并回显合并结果；`tests/unit/core/worldbook/st-format.service.spec.ts`、`tests/unit/composables/useWorldbookControl.spec.ts`：新增 alias 合并回归用例 | Aligned | 本轮已打通 UI→控制层→服务层链路 |

### B 小结（建议打分）：45 / 45

---

## 5. C 维度：工程质量矩阵

| 项目 | 证据 | 状态 |
| --- | --- | --- |
| CI Node/pnpm/锁文件安装口径 | `.github/workflows/test.yaml` / `build.yaml`：Node `24`、pnpm `10`、`pnpm install --frozen-lockfile` | Aligned |
| CI 测试门禁 | `test.yaml` 已包含并执行 `pnpm lint` + `pnpm test --run` + `pnpm build:dev` | Aligned |
| 本地门禁可执行性 | 本轮复验：`pnpm lint -- --max-warnings=20`、`pnpm test --run`、`pnpm build:dev` 全通过 | Aligned |
| 覆盖率阈值（Lines >= 70） | 本轮 `pnpm test:coverage`：`Lines 74.21%` | Aligned |

### C 小结（建议打分）：20 / 20

---

## 6. 加权结果（可复算）

- A：31 / 35
- B：45 / 45
- C：20 / 20

### 当前总分：96 / 100（≈96%）

说明：

- 已达到并稳定高于本阶段目标（`85%+`）；
- T5/T6（SillyTavern 完整格式导入导出、导入合并预览/确认、冲突夹具回归）已闭环；
- T9（稳定性观测与最终报告）已补齐；
- 本轮补齐 alias 合并 UI 与导入流程联动，消除 B 维度剩余主要差距。

---

## 7. 旧计划 TODO 漂移复核（`.limcode/plans/novelToST-full-replica-gap-closure-plan.md`）

| TODO ID | 复核结论 | 依据 |
| --- | --- | --- |
| `#todo-gap-final-alignment-report` | 已实现 | 本文档最终版 + T9 稳定性证据 |
| `#todo-gap-stage1-debug-tools` | 已实现 | `commands/debug.ts` + `debug.int.spec.ts` |
| `#todo-gap-stage1-generation-hooks` | 已实现 | `generation.service.ts` 调用 send/reply guard |
| `#todo-gap-stage1-help-modal` | 部分实现 | 有 `HelpPanel.vue`，但非完整“问号弹窗体系” |
| `#todo-gap-stage1-settings-schema` | 已实现 | `settings.store.ts` 新增阶段参数字段 |
| `#todo-gap-stage1-toast-detection` | 已实现 | `guard.service.ts` 两阶段检测 |
| `#todo-gap-stage1-ui-advanced` | 已实现 | `GenerationForm.vue` 分组配置项 |
| `#todo-gap-stage2-api-adapter` | 已实现 | `api.service.ts` 多提供商调用 |
| `#todo-gap-stage2-chunk-task-model` | 已实现 | `chunk.service.ts` + `worldbook.store.ts` |
| `#todo-gap-stage2-convert-engine` | 已实现 | `process.service.ts` |
| `#todo-gap-stage2-export-format` | 已实现 | `st-format.service.ts` + `WorldbookPanel.vue` / `ImportMergeModal.vue` |
| `#todo-gap-stage2-persistence` | 已实现 | `history-db.service.ts` + `task-io.service.ts` |
| `#todo-gap-stage2-worldbook-setup` | 未实现（且口径需调整） | 未采用 `src/novelToST-worldbook/` 独立目录方案 |
| `#todo-gap-stage3-batch-merge` | 已实现（基础版） | `WorldbookResultPanel.vue` 多选删除 + `MemoryQueuePanel.vue` 上下合并 + `useWorldbookControl.ts` 撤销快照 |
| `#todo-gap-stage3-failure-repair` | 已实现 | `MemoryQueuePanel.vue` 失败修复队列 + `useWorldbookControl.ts` 单/批失败重试 |
| `#todo-gap-stage3-history-rollback` | 已实现 | `HistoryModal.vue` + rollback API |
| `#todo-gap-stage3-import-export` | 已实现（任务/设置） | `task-io.service.ts` + UI 导入导出 |
| `#todo-gap-stage3-observability-stability` | 已实现（本轮补齐） | T9 观测窗口 A/B + 门禁回归日志 |

---

## 8. 残余风险与后续建议

1. **`pnpm exec tsc --noEmit` 仍失败（非本轮门禁项）**
   - 现状：主要失败位于 `@types/function/*.d.ts`（`PartialDeep` / `LiteralUnion` / `SetRequired` 等）与少量测试类型断言。
   - 影响：若后续将严格 typecheck 纳入 CI，将成为阻塞项。

2. **lint 仍保留 1 条既有 warning**
   - 位置：`vitest.config.ts` line `1`
   - 规则：`import-x/no-nodejs-modules`
   - 建议：统一决定“保留白名单”或按规则改造配置文件。

3. **长稳窗口仍偏短**
   - 本轮可复验窗口累计 `2.70` 分钟，已能证明短时重复执行稳定；
   - 若需“2h soak”级别证据，建议在 CI 夜间任务中追加长时回归流水线。

---

## 9. 最终结论

- 本阶段目标（`85%+`）已达到并稳定保持：**96 / 100**。
- 关键高优先缺口（T5/T6/T9）均已完成并具备代码 + 测试 + 命令证据链；别名合并 UI 导入链路已完成打通。
- 当前可进入收尾交付；后续增强建议聚焦 strict typecheck 治理与长稳 soak 自动化。
